The `upload_files` function is an asynchronous handler designed to process file uploads within a web application context. Its primary purpose is to manage the uploading of files associated with a specific user and knowledge base. The function performs the following key tasks:

1. **User Validation**: It verifies the validity of the user ID provided in the request. If the user ID is invalid, it returns an error message.

2. **File Retrieval**: It retrieves files either from the local system or from the request, depending on the configuration.

3. **Knowledge Base Validation**: It checks whether the specified knowledge base ID exists for the user. If not, it returns an error message.

4. **Filename Processing**: It processes filenames to remove certain characters and truncates them if necessary. It also handles duplicate filenames based on the specified mode ('soft' or 'strong').

5. **File Management**: It adds new files to the system, generates a unique file ID, and updates the file size information. Files are prepared for insertion into a storage system.

6. **Asynchronous Storage**: It initiates an asynchronous task to insert the files into a storage backend.

7. **Response Generation**: It constructs a response message indicating the success of the operation or warning about any issues related to duplicate filenames.

Overall, the function orchestrates the secure and efficient handling of file uploads, ensuring proper validation and management according to the specified operational mode.